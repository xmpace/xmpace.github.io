---
layout: post
title: "单点登录系统高可用架构"
excerpt: 单点登录系统的高可用架构
background: /img/bg-post.jpg
---

一种是集中式的，登录 token 及业务 token 的颁发和校验都在一个地方，风险是一旦挂了，全局都挂。

改进式的高可用架构是，登录 token 颁发放一个地方，客户端拿到这个 token 后找业务方要业务 token，业务方拿登录 token 找登录中心校验用户数据，登录中心返回用户数据，业务方拿到用户数据后生成业务 token，返回给客户端。之后客户端用业务 token 与业务方交互，登录后就不再需要登录中心了，除了 token 过期的时候。这样可以隔离各个业务与登录中心的风险。

要求：
1.主站token用来表示用户已在全站登录，只存在主站，不允许复制到子站
2.子站token隔离，降低交叉泄露的风险
3.子站token生成后自治，不去主站鉴权，去中心化
4.子站token设有效期
5.子站token过期时，一需要重新生成子站token，二需要refresh登录站token，表示活跃用户
6.子站怎么去refresh主站token？

需求：
1.任何一个子站处于登录态，跳转到其他子站就必须能无缝转换到登录态

实现：
1.子站token过期则跳转到主站去登录，子站token过期时间比主站token过期时间短
2.主站拿token去申请子站token时，顺便把自己的token也refresh了，服务端逻辑为旧token延时1分钟过期
3.退出登录时，主站失效token后，还应该发消息给各子站，通知子站失效子站token
4.考虑到要求6，子站除了跳转到主站去refresh主站的token外，别无他法，因此，为了照顾用户体验，子站去主站refresh间隔必须长一点，也就是说主站的token过期时间应该尽量长一点
5.客户端一律无限过期时间，由服务端设


说明：
1.refresh有两个作用，一是判断token有没有被泄露，二是起个心跳的作用，表示我还活跃着，所以refresh的处理逻辑应该包含两个功能，一是检测到被泄露（被别人refresh过）则失效所有登录token，让用户重新登录，二是续约登录态
2.主站子站都有检测被泄露的需求，为了满足需求1，主站必须支持续约，所以主站子站都需要实现refresh双token
3.主站为子站申请的token是一次性的，子站拿着这个token能查到账号id，接着就自己生成token自己玩了，主站就可以销毁这个token了，为实现简单，可以将这个一次性token设一个较短的过期时间
4.子站refresh token的过期时间应该与主站token过期时间一致，主站的token过期时间的含义是用户在全站多久无操作即需要重新登录，长期无操作，说明用户不用这个设备了，但可能忘了退出，这时候应该自动帮用户退出，所以token需要过期时间
5.主站token二合一，只有一个token，既用来申请子站token，也用来刷新自身
6.refresh token被黑客拿到，refresh 只有一个会成功，失败的那个如果继续请求，就应该把另一个成功的顶下线，以保证安全
7.考虑到上一条，token应该有tokenId编号，相关联的token用一个id，比如token refresh后tokenId不变，因此只要保证每次登录生成的tokenId不一样就行，random16即可，理论上，允许同时登录多少个实例，就用多少个编号做tokenId就行
8.子站的token中也应该包含tokenId，这个tokenId应该与主站tokenId一样

总结：
1.为了保证用户体验，token通过refresh续约，不续约，token就一定会过期，如果token被黑客拿到，黑客也要续约，这时服务端就能发现多于一个用户来续约，以此证明token被盗
2.发现被盗时，必须有机制踢对方下线（黑客也能踢用户下线，但只要token不泄露别人是无法踢用户下线的，所以也可以接受）


另一种方案：
上面的方案，在主站token快过期时，需要跳转到主站去refresh，对用户体验有影响。这里给出另一种方案。

要避免跳转到主站，那就只能舍去主站的refresh了，因为主站的refresh只能通过跳转实现。

服务端设一个过期时间，子站以这个过期时间间隔来刷新服务端的主站token过期时间。

但如果主站token被盗怎么办呢？黑客也会拿这个token去申请子站token，这时子站能检测到同一个主站token，申请了两个子站token，可以发现被盗。

然而用户也可能直接点开主站的链接，这时候主站以为用户要申请子站token，发了新的token，导致子站以为主站token被盗，解决办法是主站链接必须有参数区分访问意图，是想登录还是想申请新的token。